#!/bin/bash

# 模块基本信息
MODULE_NAME="网络信息查看工具（sk23022）"
VERSION="v1.0"

# 显示模块帮助信息
show_help() {
    echo "=================================================="
    echo "$MODULE_NAME $VERSION"
    echo "=================================================="
    echo "使用格式：$0 [功能选项] [参数]"
    echo "功能选项说明："
    echo "  -i        查看所有网络接口及IP地址信息"
    echo "  -p        查看TCP/UDP协议的监听端口信息"
    echo "  -ping <ip>  对指定IP执行Ping测试（4个数据包）并生成报告"
    echo "  --help    显示本帮助信息"
    echo "=================================================="
    echo "使用示例："
    echo "  $0 -i                  # 查看网络接口及IP信息"
    echo "  $0 -p                  # 查看监听端口信息"
    echo "  $0 -ping 172.1.1.6     # Ping测试 172.1.1.6 并生成报告"
    echo "=================================================="
}

# 功能1：查看网络接口及IP信息
show_network_interfaces() {
    echo "=== 系统网络接口及IP信息 ==="
    # 提取网络接口名称和IP地址
    ip addr | grep -E '^[0-9]+: |inet ' | awk '
        /^[0-9]+:/ {print "\n接口名称：" $2}
        /inet / {print "  IP地址：" $2}
    '
}

# 功能2：查看TCP/UDP监听端口信息
show_listen_ports() {
    echo "=== TCP/UDP监听端口信息 ==="
    echo "协议  本地地址:端口  状态"
    echo "----------------------------"
    # 提取TCP/UDP监听端口，格式化输出
    ss -tuln 2>/dev/null | awk 'NR>1 {
        split($4, addr, ":");
        port = addr[length(addr)];
        printf "%-4s %-15s %s\n", $1, $4, $5
    }'
    # 检查是否有监听端口
    if [ -z "$(ss -tuln 2>/dev/null | grep -v 'State')" ]; then
        echo "当前系统暂无TCP/UDP监听端口！"
    fi
}

# 功能3：Ping测试与报告生成
ping_test_and_report() {
    local target_ip=$1
    # 检查IP参数是否为空
    if [ -z "$target_ip" ]; then
        echo "错误：缺少目标IP参数！使用格式：$0 -ping <ip>"
        return 1
    fi
    # 生成报告文件名（包含时间戳）
    local report_file="ping_report_${target_ip}_$(date +%Y%m%d_%H%M%S).txt"
    echo "=== 正在对 $target_ip 执行Ping测试（发送4个数据包）==="
    echo "测试报告将保存至：$report_file"
    # 执行Ping测试并生成报告
    echo "Ping测试报告 - 目标IP：$target_ip" > "$report_file"
    echo "测试时间：$(date +"%Y-%m-%d %H:%M:%S")" >> "$report_file"
    echo "========================================" >> "$report_file"
    ping -c 4 -w 5 "$target_ip" 2>&1 >> "$report_file"
    # 检查Ping测试结果
    if grep -q "0% packet loss" "$report_file"; then
        echo "Ping测试结果：成功（无丢包）"
        echo "测试摘要：$(grep "rtt min/avg/max/mdev" "$report_file")"
    elif grep -q "100% packet loss" "$report_file"; then
        echo "Ping测试结果：失败（100%丢包）"
    else
        echo "Ping测试结果：部分丢包，详细信息请查看报告文件"
    fi
}

# 主逻辑处理
if [ $# -eq 0 ]; then
    show_help
elif [ "$1" == "--help" ]; then
    show_help
else
    case "$1" in
        -i)
            show_network_interfaces
            ;;
        -p)
            show_listen_ports
            ;;
        -ping)
            ping_test_and_report "$2"
            ;;
        *)
            echo "错误：无效的功能选项 '$1'！"
            echo "请使用 $0 --help 查看正确的操作方法。"
            ;;
    esac
fi
